// Numerically Controller Oscillator functions

#include "xparameters.h" 
#include "xil_printf.h"
#include "xil_io.h"
#include "nco.h"

const uint32_t sine_lut[SIZE_OF_SINE_LUT] = { 0x8000, 0x8192, 0x8324, 0x84b6, 0x8647, 0x87d9, 0x896a, 0x8afb, 0x8c8b, 0x8e1b, 0x8fab, 0x9139, 0x92c8, 0x9455, 0x95e2, 0x976d, 0x98f8, 0x9a82, 0x9c0b, 0x9d93, 0x9f19, 0xa09f, 0xa223, 0xa3a6, 0xa528, 0xa6a8, 0xa826, 0xa9a3, 0xab1f, 0xac98, 0xae11, 0xaf87, 0xb0fb, 0xb26e, 0xb3de, 0xb54d, 0xb6ba, 0xb824, 0xb98c, 0xbaf2, 0xbc56, 0xbdb8, 0xbf17, 0xc073, 0xc1ce, 0xc325, 0xc47a, 0xc5cd, 0xc71c, 0xc869, 0xc9b4, 0xcafb, 0xcc3f, 0xcd81, 0xcebf, 0xcffb, 0xd133, 0xd269, 0xd39b, 0xd4ca, 0xd5f5, 0xd71d, 0xd842, 0xd964, 0xda82, 0xdb9d, 0xdcb4, 0xddc7, 0xded7, 0xdfe3, 0xe0ec, 0xe1f1, 0xe2f2, 0xe3ef, 0xe4e8, 0xe5dd, 0xe6cf, 0xe7bd, 0xe8a6, 0xe98c, 0xea6d, 0xeb4a, 0xec24, 0xecf9, 0xedca, 0xee96, 0xef5f, 0xf023, 0xf0e2, 0xf19e, 0xf255, 0xf307, 0xf3b5, 0xf45f, 0xf504, 0xf5a5, 0xf641, 0xf6d9, 0xf76c, 0xf7fa, 0xf884, 0xf909, 0xf98a, 0xfa05, 0xfa7d, 0xfaef, 0xfb5d, 0xfbc5, 0xfc29, 0xfc89, 0xfce3, 0xfd39, 0xfd8a, 0xfdd6, 0xfe1d, 0xfe5f, 0xfe9d, 0xfed5, 0xff09, 0xff38, 0xff62, 0xff87, 0xffa7, 0xffc2, 0xffd8, 0xffe9, 0xfff6, 0xfffd, 0x10000, 0xfffd, 0xfff6, 0xffe9, 0xffd8, 0xffc2, 0xffa7, 0xff87, 0xff62, 0xff38, 0xff09, 0xfed5, 0xfe9d, 0xfe5f, 0xfe1d, 0xfdd6, 0xfd8a, 0xfd39, 0xfce3, 0xfc89, 0xfc29, 0xfbc5, 0xfb5d, 0xfaef, 0xfa7d, 0xfa05, 0xf98a, 0xf909, 0xf884, 0xf7fa, 0xf76c, 0xf6d9, 0xf641, 0xf5a5, 0xf504, 0xf45f, 0xf3b5, 0xf307, 0xf255, 0xf19e, 0xf0e2, 0xf023, 0xef5f, 0xee96, 0xedca, 0xecf9, 0xec24, 0xeb4a, 0xea6d, 0xe98c, 0xe8a6, 0xe7bd, 0xe6cf, 0xe5dd, 0xe4e8, 0xe3ef, 0xe2f2, 0xe1f1, 0xe0ec, 0xdfe3,
0xded7, 0xddc7, 0xdcb4, 0xdb9d, 0xda82, 0xd964, 0xd842, 0xd71d, 0xd5f5, 0xd4ca, 0xd39b, 0xd269, 0xd133, 0xcffb, 0xcebf, 0xcd81, 0xcc3f, 0xcafb, 0xc9b4, 0xc869, 0xc71c, 0xc5cd, 0xc47a, 0xc325, 0xc1ce, 0xc073, 0xbf17, 0xbdb8, 0xbc56, 0xbaf2, 0xb98c, 0xb824, 0xb6ba, 0xb54d, 0xb3de, 0xb26e, 0xb0fb, 0xaf87, 0xae11, 0xac98, 0xab1f, 0xa9a3, 0xa826, 0xa6a8, 0xa528, 0xa3a6, 0xa223, 0xa09f, 0x9f19, 0x9d93, 0x9c0b, 0x9a82, 0x98f8, 0x976d, 0x95e2, 0x9455, 0x92c8, 0x9139, 0x8fab, 0x8e1b, 0x8c8b, 0x8afb, 0x896a, 0x87d9, 0x8647, 0x84b6, 0x8324, 0x8192, 0x8000, 0x7e6d, 0x7cdb, 0x7b49, 0x79b8, 0x7826, 0x7695, 0x7504, 0x7374, 0x71e4, 0x7054, 0x6ec6, 0x6d37, 0x6baa, 0x6a1d, 0x6892, 0x6707, 0x657d, 0x63f4, 0x626c, 0x60e6, 0x5f60, 0x5ddc, 0x5c59, 0x5ad7, 0x5957, 0x57d9, 0x565c, 0x54e0, 0x5367, 0x51ee, 0x5078, 0x4f04, 0x4d91, 0x4c21, 0x4ab2, 0x4945, 0x47db, 0x4673, 0x450d, 0x43a9, 0x4247, 0x40e8, 0x3f8c, 0x3e31, 0x3cda, 0x3b85, 0x3a32, 0x38e3, 0x3796, 0x364b, 0x3504, 0x33c0, 0x327e, 0x3140, 0x3004, 0x2ecc, 0x2d96, 0x2c64, 0x2b35, 0x2a0a, 0x28e2, 0x27bd, 0x269b, 0x257d, 0x2462, 0x234b, 0x2238, 0x2128, 0x201c, 0x1f13, 0x1e0e, 0x1d0d, 0x1c10, 0x1b17, 0x1a22, 0x1930, 0x1842, 0x1759, 0x1673, 0x1592, 0x14b5, 0x13db, 0x1306, 0x1235, 0x1169, 0x10a0, 0xfdc, 0xf1d, 0xe61, 0xdaa, 0xcf8, 0xc4a, 0xba0, 0xafb, 0xa5a, 0x9be, 0x926, 0x893, 0x805, 0x77b, 0x6f6, 0x675, 0x5fa, 0x582, 0x510, 0x4a2, 0x43a, 0x3d6, 0x376, 0x31c, 0x2c6, 0x275, 0x229, 0x1e2, 0x1a0, 0x162, 0x12a, 0xf6, 0xc7, 0x9d, 0x78, 0x58, 0x3d, 0x27, 0x16,
0x9, 0x2, 0x0, 0x2, 0x9, 0x16, 0x27, 0x3d, 0x58, 0x78, 0x9d, 0xc7, 0xf6, 0x12a, 0x162, 0x1a0, 0x1e2, 0x229, 0x275, 0x2c6, 0x31c, 0x376, 0x3d6, 0x43a, 0x4a2, 0x510, 0x582, 0x5fa, 0x675, 0x6f6, 0x77b, 0x805, 0x893, 0x926, 0x9be, 0xa5a, 0xafb, 0xba0, 0xc4a, 0xcf8, 0xdaa, 0xe61, 0xf1d, 0xfdc, 0x10a0, 0x1169, 0x1235, 0x1306, 0x13db, 0x14b5, 0x1592, 0x1673, 0x1759, 0x1842, 0x1930, 0x1a22, 0x1b17, 0x1c10, 0x1d0d, 0x1e0e, 0x1f13, 0x201c, 0x2128, 0x2238, 0x234b, 0x2462, 0x257d, 0x269b, 0x27bd, 0x28e2, 0x2a0a, 0x2b35, 0x2c64, 0x2d96, 0x2ecc, 0x3004, 0x3140, 0x327e, 0x33c0, 0x3504, 0x364b, 0x3796, 0x38e3, 0x3a32, 0x3b85, 0x3cda, 0x3e31, 0x3f8c, 0x40e8, 0x4247, 0x43a9, 0x450d, 0x4673, 0x47db, 0x4945, 0x4ab2, 0x4c21, 0x4d91, 0x4f04, 0x5078, 0x51ee, 0x5367, 0x54e0, 0x565c, 0x57d9, 0x5957, 0x5ad7, 0x5c59, 0x5ddc, 0x5f60, 0x60e6, 0x626c, 0x63f4, 0x657d, 0x6707, 0x6892, 0x6a1d, 0x6baa, 0x6d37, 0x6ec6, 0x7054, 0x71e4, 0x7374, 0x7504, 0x7695, 0x7826, 0x79b8, 0x7b49, 0x7cdb, 0x7e6d };


void nco_init(nco_t * nco, uint32_t frequency, uint32_t sample_frequency){
    nco->frequency   = nco_normalize_frequency(frequency, sample_frequency);
    nco->phase       = nco_phase_init(nco->frequency);
    nco->accumulator = 0;
}

// Normalize the requested output frequency based on the sample frequency
float nco_normalize_frequency(uint32_t frequency, uint32_t sample_frequency) {
    float frequency_normalized = (float)frequency/(float)sample_frequency;
    return frequency_normalized;
}

uint32_t nco_phase_init(float frequency_norm) {
    // Normalized Frequency * Size of the sine LUT = 0 .. Size of the sine LUT
    float phase_float = frequency_norm * (float)SIZE_OF_SINE_LUT * (float)( 1 << FRACTION_SIZE );//0x800000;//8388608;
    return (uint32_t)phase_float;
}

void nco_load_sine_to_mem(nco_t *nco) {
    uint32_t accumulator_int = nco->accumulator;
    uint32_t lut_index = (accumulator_int >> FRACTION_SIZE) & 0x1ff;
    audio_data_t *audio_data = nco->audio_data;
    uint32_t data = 0;

    for (int i = 0; i < nco->target_memory_size; i++) {
        data = sine_lut[lut_index] >> 2;
        *audio_data = (audio_data_t){ data, data };
        audio_data ++;
        accumulator_int += nco->phase;
        lut_index = (accumulator_int >> FRACTION_SIZE) & 0x1ff;
    }
    nco->accumulator = accumulator_int;
}
